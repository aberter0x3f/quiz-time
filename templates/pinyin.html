{% extends "base.html" %}

{% block title %}Quiz Pinyin{% endblock %}

{% block extra_styles %}
  <style>
    .py-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 1rem;
    }
    .py-tag {
      font-family: monospace;
      cursor: default;
    }
    .history-box {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 1rem;
      background: #fdfdfd;
    }
  </style>
{% endblock %}

{% block content %}
  <div id="game-workspace">
    <h4 class="ui header">Initials</h4>
    <div class="py-grid" id="initials-box"></div>
    <h4 class="ui header">Finals</h4>
    <div class="py-grid" id="finals-box"></div>

    <div class="ui divider"></div>

    <div id="history-section">
      <h4 class="ui header">History</h4>
      <div class="history-box" id="history-list"></div>
    </div>

    <div id="task-area" class="ui segment blue">
      <h3 class="ui header">Your Task / Info</h3>
      <p id="prompt-text" style="font-size: 1.2rem; font-weight: bold;"></p>
      <div id="prompt-warning" class="ui message yellow hidden"></div>
    </div>
  </div>

  <div id="result-area" style="display:none;"></div>
{% endblock %}

{% block scripts %}
  <script>
    function renderGame(state) {
      renderPinyinTable(
        "initials-box",
        state.all_initials,
        state.banned_initials,
      );
      renderPinyinTable("finals-box", state.all_finals, state.banned_finals);

      const histBox = document.getElementById("history-list");
      histBox.innerHTML = "";
      if (state.history && state.history.length > 0) {
        state.history.forEach((h) => {
          const div = document.createElement("div");
          div.className = "ui segment tiny";
          div.innerHTML = `<strong>${h.player}:</strong> ${h.content}`;
          histBox.appendChild(div);
        });
      } else {
        histBox.innerHTML =
          "<div class='ui message'>No visible history yet.</div>";
      }

      const promptEl = document.getElementById("prompt-text");
      const warnEl = document.getElementById("prompt-warning");
      warnEl.classList.add("hidden");
      warnEl.innerText = "";

      if (state.phase === "Settlement") {
        document.getElementById("task-area").style.display = "none";
        document.getElementById("history-section").style.display = "none";

        const resArea = document.getElementById("result-area");
        resArea.style.display = "block";
        resArea.innerHTML = `
            <div class="ui segment ${state.winner ? "green" : "red"}">
                <h2 class="ui header">${state.winner ? "Game Success" : "Game Failed"}</h2>
                <p><strong>Correct Answer:</strong> ${state.correct_answer}</p>
                <p>${state.end_message}</p>
            </div>
            <div class="ui segment">
               <h4 class="ui header">Full History</h4>
               <div class="ui list relaxed">
                 ${(state.full_history || []).map((h) => `<div class="item"><strong>${h.player}</strong>: ${h.content} ${h.is_guess ? "(Final Guess)" : ""}</div>`).join("")}
               </div>
            </div>
        `;
        return;
      }

      // 游戏进行中，显示任务区和历史区
      document.getElementById("game-workspace").style.display = "block";
      document.getElementById("task-area").style.display = "block";
      document.getElementById("history-section").style.display = "block";
      document.getElementById("result-area").style.display = "none";

      if (state.my_prompt) {
        promptEl.innerText = "Received: " + state.my_prompt;
        if (state.is_first_turn) {
          warnEl.innerText =
            "You are the first player! You cannot use initials/finals contained in the answer.";
          warnEl.classList.remove("hidden");
        }
      } else {
        promptEl.innerText = "(Waiting for your turn...)";
      }
    }

    function renderPinyinTable(id, allList, bannedList) {
      const container = document.getElementById(id);
      container.innerHTML = "";
      if (!allList) return;
      allList.forEach((py) => {
        const span = document.createElement("span");
        const isBanned = bannedList && bannedList.includes(py);
        span.className = `ui label large py-tag ${isBanned ? "red" : "basic"}`;
        span.innerText = py || "∅";
        container.appendChild(span);
      });
    }

    function renderControls(ctrl, me, state) {
      if (state.phase === "Settlement") {
        ctrl.innerHTML = '<div class="ui message">Game Over.</div>';
        return;
      }

      // Pinyin 模式: Gaming 阶段且轮到我
      if (state.phase === "Gaming" && me.is_active_turn) {
        const btnText = state.is_guessing_turn
          ? "Final Guess"
          : "Send Description";
        const placeholder = state.is_guessing_turn
          ? "Guess the answer..."
          : "Describe the text using valid chars...";

        // 智能复用 DOM，避免输入法中断
        let inputEl = document.getElementById("ans-input");
        let btnEl = document.getElementById("ans-btn");
        if (inputEl) {
          inputEl.placeholder = placeholder;
          if (btnEl) {
            btnEl.innerText = btnText + " (--s)"; // 仅占位，实际时间由 timer 更新
            btnEl.innerHTML = `${btnText} (<span class="timer-text">--</span>)`;
          }
        } else {
          // 不存在则创建
          const oldInput = document.getElementById("ans-input");
          const draft = oldInput ? oldInput.value : "";
          ctrl.innerHTML = `
             <div class="ui action input fluid">
               <input type="text" id="ans-input" placeholder="${placeholder}" autocomplete="off">
               <button class="ui primary button" id="ans-btn" onclick="sendAnswer()">
                 ${btnText} (<span class="timer-text">--</span>)
               </button>
             </div>`;
          document.getElementById("ans-input").value = draft;
          // 自动聚焦
          document.getElementById("ans-input").focus();
        }
      } else {
        ctrl.innerHTML = `
           <div class="ui message info">
             <div class="header">Current Turn: ${state.current_player_id || "None"}</div>
             <p>Time remaining: <span class="timer-text">--</span></p>
           </div>`;
      }
    }
  </script>
{% endblock %}
