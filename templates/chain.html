{% extends "base.html" %}

{% block title %}Quiz Chain{% endblock %}

{% block top_buttons %}
  <button
    class="ui mini icon button basic"
    onclick="copyContent()"
    title="Copy content"
  >
    <i class="copy outline icon"></i> Copy
  </button>
{% endblock %}

{% block content %}
  <div class="char-grid" id="grid-box"></div>
  <div id="result-area" style="margin-top: 2rem;"></div>
{% endblock %}

{% block scripts %}
  <script>
    function copyContent() {
      if (!gameState || !gameState.grid) return;
      const text = gameState.grid
        .map((c) => (c.char_content ? c.char_content : ""))
        .join("");
      navigator.clipboard.writeText(text).then(
        () =>
          $("body").toast({
            class: "success",
            message: `Copied ${text.length} characters.`,
          }),
        () => $("body").toast({ class: "error", message: "Failed to copy." }),
      );
    }

    // 渲染游戏特定区域（网格）
    function renderGame(state) {
      const grid = document.getElementById("grid-box");
      grid.innerHTML = "";
      state.grid.forEach((cell) => {
        const div = document.createElement("div");
        div.className = "char-cell ui";
        if (cell.owner_color_hue !== null) {
          div.style.backgroundColor = `hsl(${cell.owner_color_hue}, 70%, 85%)`;
        } else {
          div.style.backgroundColor = "#eee";
        }
        if (cell.char_content) div.innerText = cell.char_content;
        grid.appendChild(div);
      });

      const resArea = document.getElementById("result-area");
      if (state.phase === "Settlement") {
        resArea.style.display = "block";
        let html = `
      <div class="ui segment">
        <h2 class="ui header">Result</h2>
        <div class="ui message info"><strong>Correct Answer:</strong> ${state.correct_answer}</div>
        <h4 class="ui header">Player Submissions</h4>
        <div class="ui list">
    `;
        state.players.forEach((p) => {
          const isCorrect = p.answer === state.correct_answer;
          const icon = isCorrect ? "check green" : "times red";
          html += `<div class="item"><i class="${icon} icon"></i><div class="content"><strong>${p.id}</strong>: ${p.answer || "(No Answer)"}</div></div>`;
        });
        resArea.innerHTML = html + "</div></div>";
      } else if (state.is_super) {
        resArea.style.display = "block";
        resArea.innerHTML = `<div class="ui segment red"><h4 class="ui header">Super Info</h4><p>Correct: ${state.correct_answer || "???"}</p></div>`;
      } else {
        resArea.style.display = "none";
      }
    }

    // 渲染控制栏
    function renderControls(ctrl, me, state) {
      if (me.status === "Submitted") {
        ctrl.innerHTML =
          '<div class="ui message success">Submission received.</div>';
        return;
      }
      // Chain 模式: 答题阶段 或者 (Picking 阶段且已 Stop)
      if (
        state.phase === "Answering" ||
        (state.phase === "Picking" && me.status === "Stopped")
      ) {
        const oldInput = document.getElementById("ans-input");
        const draft = oldInput ? oldInput.value : me.answer || "";
        ctrl.innerHTML = `
         <div class="ui action input fluid">
           <input type="text" id="ans-input" placeholder="Your answer...">
           <button class="ui primary button" onclick="sendAnswer()">
             Submit ${state.phase === "Answering" ? '(<span class="timer-text">--</span>)' : ""}
           </button>
         </div>`;
        document.getElementById("ans-input").value = draft;
        return;
      }

      if (state.phase === "Picking") {
        if (me.status === "Picking") {
          ctrl.innerHTML = `
            <div class="ui buttons fluid">
              <button class="ui primary button" onclick="sendAction('take')"><i class="hand pointer icon"></i> Take (<span class="timer-text">--</span>)</button>
              <div class="or"></div>
              <button class="ui negative button" onclick="sendAction('stop')">Stop</button>
            </div>`;
        } else {
          ctrl.innerHTML =
            '<div class="ui message">Wait for your turn...</div>';
        }
      } else if (state.phase === "Settlement") {
        ctrl.innerHTML = '<div class="ui message">Game Over.</div>';
      } else {
        ctrl.innerHTML = '<div class="ui message info">Waiting to start.</div>';
      }
    }
  </script>
{% endblock %}
