<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz Chain</title>
    <script src="https://unpkg.com/jquery@3.7.1/dist/jquery.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://unpkg.com/fomantic-ui@2.9.4/dist/semantic.min.css"
    />
    <script src="https://unpkg.com/fomantic-ui@2.9.4/dist/semantic.min.js"></script>
    <style>
      body {
        background-color: #f7f7f7;
        height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: row;
      }
      .app-container {
        display: flex;
        width: 100%;
        height: 100vh;
      }
      .sidebar-panel {
        width: 260px;
        overflow-y: auto;
        border-right: 1px solid rgba(34, 36, 38, 0.15);
        background: #fff;
      }
      .main-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .log-panel {
        width: 300px;
        overflow-y: auto;
        border-left: 1px solid rgba(34, 36, 38, 0.15);
        background: #fff;
        padding: 1rem;
      }
      .content-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
      }
      .char-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      .char-cell {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      /* 移动端适配修改 */
      @media (max-width: 900px) {
        body {
          flex-direction: column;
          height: auto;
          padding-bottom: 90px;
        }
        .app-container {
          flex-direction: column;
          height: auto;
        }
        .sidebar-panel,
        .log-panel {
          width: 100%;
          max-height: 250px;
          border-right: none;
          border-bottom: 1px solid rgba(34, 36, 38, 0.15);
        }
        .log-panel {
          border-left: none;
          border-top: 1px solid rgba(34, 36, 38, 0.15);
          background: #fcfcfc;
        }
        .main-panel {
          height: auto;
          overflow: visible;
        }
        .content-scroll {
          overflow: visible;
          height: auto;
          padding: 1rem;
        }
        #control-box {
          position: fixed;
          top: auto;
          bottom: 0;
          left: 0;
          width: 100%;
          height: auto;
          z-index: 1000;
          margin: 0;
          border-radius: 0;
          border: none;
          border-top: 1px solid rgba(34, 36, 38, 0.15);
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- 玩家列表侧边栏 -->
      <div class="sidebar-panel">
        <div class="ui fluid vertical menu" id="player-list">
          <div class="header item">Players</div>
        </div>
      </div>

      <!-- 主游戏区域 -->
      <div class="main-panel">
        <div class="ui top attached segment">
          <h3 class="ui header" id="hint-box">Loading...</h3>
        </div>

        <div class="ui attached segment content-scroll">
          <div class="char-grid" id="grid-box"></div>

          <div id="result-area" style="margin-top: 2rem;">
            <!-- 结算结果 -->
          </div>
        </div>

        <div class="ui bottom attached segment center aligned" id="control-box">
          <div class="ui active inline loader" id="status-loader"></div>
          <span id="status-text">Connecting...</span>
        </div>
      </div>

      <!-- 日志面板 -->
      <div class="log-panel">
        <h4 class="ui dividing header">System Logs</h4>
        <div class="ui small feed" id="log-box"></div>
      </div>
    </div>

    <script>
      const isSpectate = "{{ is_spectate }}".toLowerCase() === "true";
      const username = "{{ username }}";
      let socket;
      let gameState = null;
      let timerInterval = null;
      let currentGameId = null;

      function connect() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const qs = isSpectate ? "?spectate=true" : "";
        socket = new WebSocket(`${protocol}//${window.location.host}/ws${qs}`);

        socket.onopen = () => {
          document.getElementById("status-loader").classList.remove("active");
          document.getElementById("status-text").innerText = "Connected";

          setInterval(
            () =>
              socket.send(JSON.stringify({ type: "Heartbeat", data: null })),
            5000,
          );
          if (!timerInterval) timerInterval = setInterval(updateUiTimer, 100);
        };

        socket.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          if (msg.type === "update") {
            if (currentGameId && msg.data.game_id !== currentGameId) {
              location.reload();
              return;
            }
            currentGameId = msg.data.game_id;
            gameState = msg.data;
            render();
          } else if (msg.type === "log") {
            log(msg.data.who, msg.data.text, msg.data.time);
          } else if (msg.type === "error") {
            alert(msg.data);
          }
        };

        socket.onclose = () => {
          document.getElementById("status-loader").classList.add("active");
          document.getElementById("status-text").innerText =
            "Disconnected, retrying...";
          setTimeout(connect, 3000);
        };
      }

      function log(who, text, time) {
        const box = document.getElementById("log-box");
        const event = document.createElement("div");
        event.className = "event";
        event.innerHTML = `
          <div class="content">
            <div class="summary">
              <a class="user">${who}</a> ${text}
              <div class="date">${time}</div>
            </div>
          </div>
        `;
        box.appendChild(event);
        const panel = document.querySelector(".log-panel");
        panel.scrollTop = panel.scrollHeight;
      }

      function sendAction(act) {
        socket.send(JSON.stringify({ type: "Action", data: { action: act } }));
      }

      function sendAnswer() {
        const val = document.getElementById("ans-input").value;
        socket.send(JSON.stringify({ type: "Answer", data: { content: val } }));
      }

      function updateUiTimer() {
        if (!gameState || !gameState._localTargetTime) return;
        const rem = Math.max(
          0,
          (gameState._localTargetTime - Date.now()) / 1000,
        );
        const els = document.querySelectorAll(".timer-text");
        els.forEach((el) => (el.innerText = rem.toFixed(1) + "s"));
      }

      function render() {
        // 同步服务器截止时间到本地偏移
        if (gameState.turn_deadline_ms != null)
          gameState._localTargetTime = Date.now() + gameState.turn_deadline_ms;
        else if (gameState.answer_deadline_ms != null)
          gameState._localTargetTime =
            Date.now() + gameState.answer_deadline_ms;
        else gameState._localTargetTime = null;

        // 渲染顶部标题
        const totalChars = gameState.grid.length;
        const hintText = gameState.hint || "Waiting...";
        document.getElementById("hint-box").innerText =
          `${hintText} (${totalChars} chars)`;

        // 渲染玩家列表
        const pList = document.getElementById("player-list");
        pList.innerHTML = '<div class="header item">Players</div>';
        gameState.players.forEach((p) => {
          const item = document.createElement("div");
          item.className = "item";
          item.style.display = "flex";
          item.style.alignItems = "center";

          if (p.status === "Picking") item.classList.add("active", "teal");

          const dotColor = p.is_online ? "green" : "grey";
          const nameColor = `hsl(${p.color_hue}, 70%, 35%)`;

          // 状态点 | 名字 (Me) | (伸缩空间) | 字数
          item.innerHTML = `
            <div class="ui mini ${dotColor} empty circular label" style="margin: 0 0.8em 0 0;"></div>
            <div style="flex: 1; display: flex; flex-direction: column;">
              <div style="display: flex; align-items: center;">
                <span style="color: ${nameColor}; font-weight: bold;">${p.id}</span>
                ${p.is_me ? '<span class="ui mini blue label" style="margin-left: 0.5em; padding: 0.2em 0.5em;">Me</span>' : ""}
              </div>
              <div class="description" style="font-size: 0.85em; color: rgba(0,0,0,0.5);">${p.status}</div>
            </div>
            <div class="ui label" style="margin-left: 1em;">
              <i class="font icon"></i>${p.obtained_count}
            </div>
          `;
          pList.appendChild(item);
        });

        // 渲染网格
        const grid = document.getElementById("grid-box");
        grid.innerHTML = "";
        gameState.grid.forEach((cell) => {
          const div = document.createElement("div");
          div.className = "char-cell ui";
          if (cell.owner_color_hue !== null) {
            div.style.backgroundColor = `hsl(${cell.owner_color_hue}, 70%, 85%)`;
          } else {
            div.style.backgroundColor = "#eee";
          }
          if (cell.char_content) div.innerText = cell.char_content;
          grid.appendChild(div);
        });

        // 渲染结算区域
        const resArea = document.getElementById("result-area");
        if (gameState.phase === "Settlement") {
          resArea.style.display = "block";
          let html = `
            <div class="ui segment">
              <h2 class="ui header">Result</h2>
              <div class="ui message info"><strong>Answer:</strong> ${gameState.correct_answer}</div>
              <h4 class="ui header">Full Problem</h4>
              <p style="word-break: break-all">${gameState.full_problem}</p>
              <h4 class="ui header">Player Submissions</h4>
              <div class="ui list">
          `;
          gameState.players.forEach((p) => {
            const isCorrect = p.answer === gameState.correct_answer;
            const icon = isCorrect ? "check green" : "times red";
            const ansText = p.answer || "(No Answer)";
            html += `
              <div class="item">
                <i class="${icon} icon"></i>
                <div class="content">
                  <strong>${p.id}</strong>: ${ansText}
                </div>
              </div>
            `;
          });
          resArea.innerHTML = html + "</div></div>";
        } else {
          resArea.style.display = "none";
        }

        // 渲染控制区域
        const ctrl = document.getElementById("control-box");
        if (isSpectate) {
          ctrl.innerHTML = '<div class="ui message">Spectating Mode</div>';
          return;
        }
        const me = gameState.players.find((p) => p.is_me);
        if (!me) {
          ctrl.innerHTML = '<div class="ui message">Joining...</div>';
          return;
        }

        if (gameState.phase === "Picking") {
          if (me.status === "Picking") {
            ctrl.innerHTML = `
              <div class="ui buttons fluid">
                <button class="ui primary button" onclick="sendAction('take')">
                  <i class="hand pointer icon"></i> Take (<span class="timer-text">--</span>)
                </button>
                <div class="or"></div>
                <button class="ui negative button" onclick="sendAction('stop')">Stop</button>
              </div>
            `;
          } else {
            ctrl.innerHTML =
              '<div class="ui message">Wait for your turn...</div>';
          }
        } else if (gameState.phase === "Answering") {
          if (me.status === "Submitted") {
            ctrl.innerHTML =
              '<div class="ui message success">Submission received. Waiting for others...</div>';
          } else {
            // 保留输入框中的内容
            const oldInput = document.getElementById("ans-input");
            const draft = oldInput ? oldInput.value : me.answer || "";
            ctrl.innerHTML = `
              <div class="ui action input fluid">
                <input type="text" id="ans-input" placeholder="Your answer...">
                <button class="ui primary button" onclick="sendAnswer()">
                  Submit (<span class="timer-text">--</span>)
                </button>
              </div>
            `;
            document.getElementById("ans-input").value = draft;
          }
        } else if (gameState.phase === "Settlement") {
          ctrl.innerHTML =
            '<div class="ui message">The game has concluded．</div>';
        } else {
          ctrl.innerHTML =
            '<div class="ui message info">Waiting for the admin to start the game．</div>';
        }

        updateUiTimer();
      }

      // 页面加载完成后启动连接
      $(document).ready(connect);
    </script>
  </body>
</html>
